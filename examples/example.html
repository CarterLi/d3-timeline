<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <script src="../node_modules/d3/d3.js"></script>
  <script src="../src/d3-timeline.js"></script>

  <style type="text/css">
    #timeline {
      cursor: move;
    }

    .axis {
      pointer-events: none;
    }
    .axis path,
    .axis line,
    .line line,
    .top-line {
      fill: none;
      stroke: black;
      shape-rendering: crispEdges;
    }

    .axis text,
    .line text {
      font-family: sans-serif;
      font-size: 10px;
      stroke: none;
    }

    .timeline-label {
      font-family: sans-serif;
      font-size: 12px;
    }

    #timeline2 .axis {
      transform: translate(0px,40px);
    }

    .coloredDiv {
      height:20px; width:20px; float:left;
    }

    .hidden {
      display: none;
    }

    .line {
      stroke: black;
      pointer-events: none;
    }

    .line circle {
      fill: #eee;
    }

    .line .label {
      text-anchor: middle;
    }
  </style>
</head>
<body>
  <div>
    <h3>Test</h3>
    <div id="timeline"></div>
  </div>
  <script type="text/javascript">
    void function() {
      const iconTestData = [
        {label: 'Jackie', class: 'jackie', icon: 'jackie.png', times: [
          {'starting_time': 1355752800000, 'ending_time': 1355759900000, value: 20},
          {'starting_time': 1355767900000, 'ending_time': 1355774400000, value: 200},
          {'starting_time': 1355771900000, 'ending_time': 1355779900000, value: 100},]},
        {label: 'Troll', class: 'troll', icon: 'troll.png', times: [
          {'starting_time': 1355759910000, 'ending_time': 1355761900000, value: 50}]},
        {label: 'Wat', class: 'wat', icon: 'wat.png', times: [
          {'starting_time': 1355756010000, 'ending_time': 1355763910000, value: 25},
          {'starting_time': 1355763910000, 'ending_time': 1355773110000, value: 50}]},
        {label: 'Jackie', class: 'jackie', icon: 'jackie.png', times: [
          {'starting_time': 1355752800000, 'ending_time': 1355759900000, value: 20},
          {'starting_time': 1355767900000, 'ending_time': 1355774400000, value: 200},
          {'starting_time': 1355771900000, 'ending_time': 1355779900000, value: 100},]},
        {label: 'Jackie', class: 'jackie', icon: 'jackie.png', times: [
          {'starting_time': 1355752800000, 'ending_time': 1355759900000, value: 20},
          {'starting_time': 1355767900000, 'ending_time': 1355774400000, value: 200},
          {'starting_time': 1355771900000, 'ending_time': 1355779900000, value: 100},]},
        {label: 'Jackie', class: 'jackie', icon: 'jackie.png', times: [
          {'starting_time': 1355752800000, 'ending_time': 1355759900000, value: 20},
          {'starting_time': 1355767900000, 'ending_time': 1355774400000, value: 200},
          {'starting_time': 1355771900000, 'ending_time': 1355779900000, value: 100},]},
        {label: 'Jackie', class: 'jackie', icon: 'jackie.png', times: [
          {'starting_time': 1355752800000, 'ending_time': 1355759900000, value: 20},
          {'starting_time': 1355767900000, 'ending_time': 1355774400000, value: 200},
          {'starting_time': 1355771900000, 'ending_time': 1355779900000, value: 100},]},
        {label: 'Jackie', class: 'jackie', icon: 'jackie.png', times: [
          {'starting_time': 1355752800000, 'ending_time': 1355759900000, value: 20},
          {'starting_time': 1355767900000, 'ending_time': 1355774400000, value: 200},
          {'starting_time': 1355771900000, 'ending_time': 1355779900000, value: 100},]},
        {label: 'Jackie', class: 'jackie', icon: 'jackie.png', times: [
          {'starting_time': 1355752800000, 'ending_time': 1355759900000, value: 20},
          {'starting_time': 1355767900000, 'ending_time': 1355774400000, value: 200},
          {'starting_time': 1355771900000, 'ending_time': 1355772900000, value: 100},]},
      ];

      iconTestData.forEach(x => {
        x.maxValue = x.times.reduce((prev, curr) => Math.max(prev, curr.value), 0);
        x.times.forEach(time => time.radio = time.value / x.maxValue);
      });

      void function timelineStackedIcons() {
        const colorScale = d3.scale.linear()
          .domain([0, .5, 1])
          .interpolate(d3.interpolateHcl)
          .range([d3.rgb('#55BF3B'), d3.rgb('#DDDF0D'), d3.rgb('#DF5353')]);

        const chart = d3.timeline()
          .zoomable()
          .beginning(1355752800000)
          .showTimeAxisTick()
          .margin({left:70, right:30, top:0, bottom:0})
          .background('#eee')
          .rowSeparators('black')
          .colors(colorScale)
          .colorProperty('radio');
        const format = d3.time.format("%X")

        const svg = d3.select('#timeline').append('svg').attr('width', 1000)
          .datum(iconTestData).call(chart);

        var xrScale = d3.time.scale()
          .domain([0, 900])
          .range([chart.beginning(), chart.ending()]);

        const block = svg.select('.timeline-series-block')
          .on('mousemove', function() {
            const [x, y] = d3.mouse(this);
            line.classed('hidden', false);

            xrScale.range([chart.beginning(), chart.ending()]);

            line.attr('transform', `translate(${x} 0)`)
              .select('.label').text(format(new Date(xrScale(x))));
          });

        const { left , right } = chart.margin()
        svg.append('line')
          .attr('class', 'top-line')
          .attr('x1', left)
          .attr('x2', chart.width() - right)
          .attr('y1', 25 - 2)
          .attr('y2', 25 - 2);

        var line = block.append('g').attr('class', 'line hidden').call(g => {
          g.append('circle')
            .attr('cx', 0)
            .attr('cy', 25 - 2)
            .attr('r', 2);
          g.append('circle')
            .attr('cx', 0)
            .attr('cy', chart.height() - 25 + 1 + chart.itemMargin())
            .attr('r', 2);
          g.append('line')
            .attr('x1', 0)
            .attr('x2', 0)
            .attr('y1', 25)
            .attr('y2', chart.height() - 25 - 1 + chart.itemMargin());
          g.append('text')
            .attr('x', 2)
            .attr('y', 13)
            .attr('dy', '.71em')
            .text('Time');
          g.append('text')
            .attr('class', 'label')
            .attr('x', 0)
            .attr('y', chart.height() - 15 + chart.itemMargin())
            .attr('dy', '.71em')
            .text('? PM');
        });
      }();
    }();
  </script>
</body>
</html>
